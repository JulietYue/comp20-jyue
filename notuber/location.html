<!doctype html>

<html>
<head>
	<script src="https://maps.google.com/maps/api/js?sensor=true&libraries=geometry"></script>
	<link rel="stylesheet" href="style.css" />
<title>notuber</title>
<script>

	var latitude = 0;
	var longitude = 0;
	var loc;
	var params;
	
	function getLocation() {
		navigator.geolocation.getCurrentPosition(function(somePos) {
			latitude = somePos.coords.latitude;
			longitude = somePos.coords.longitude;
			sendMessages();
		});	
	}

	//send my location
	function sendMessages() {
		var request = new XMLHttpRequest();

		request.open("POST", "https://jordan-marsh.herokuapp.com/rides", true);
		request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

		request.onreadystatechange = function() {
			if (request.readyState == 4 && request.status == 200) {
				rawData = request.responseText;
				loc = JSON.parse(rawData);				
				console.log(loc);
				mymap();
			}
		}
		
		//set sent parameter
		params = "username=6QbTEruill&lat="
		params += latitude;
		params += "&lng=" + longitude;
		request.send(params);
	}


	function mymap()
	{
		// my location
		var my_pos = new google.maps.LatLng(latitude, longitude);
	
		var myOptions = {
			zoom: 13,
			center: my_pos,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
			
		var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

		var close = 99999;

		if(loc.vehicles){	
			for(i = 0; i < loc.vehicles.length; i++){
				var curr_pos = new google.maps.LatLng(loc.vehicles[i].lat, loc.vehicles[i].lng);
				var distance = google.maps.geometry.spherical.computeDistanceBetween(my_pos, curr_pos);

				if(close > distance) {
					close = distance;
				}

				var marker = new google.maps.Marker({
					position:curr_pos,
					title:loc.vehicles[i].username + "Distance to me is " + distance,
					icon:'car.png'
				});
				marker.setMap(map);	

				var infowindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(this.title);
					infowindow.open(map, this);
				});				
			}
		} else {
			for(i = 0; i < loc.passengers.length; i++){	
				var curr_pos = new google.maps.LatLng(loc.passengers[i].lat, loc.passengers[i].lng);
				var distance = google.maps.geometry.spherical.computeDistanceBetween(my_pos, curr_pos);

				if(close > distance) {
					close = distance;
				}

				var marker = new google.maps.Marker({
					position:curr_pos,
					title:loc.passengers[i].username + "Distance to me is " + distance,
					icon:'ppl.jpeg'
				});
				marker.setMap(map);

				var infowindow = new google.maps.InfoWindow();
				google.maps.event.addListener(marker, 'click', function() {
					infowindow.setContent(this.title);
					infowindow.open(map, this);
				});		
			}
		}
		
		//change meters to miles
		close = close * 0.000621371
		var marker = new google.maps.Marker({
			position: my_pos,
			title: '6QbTEruill. The closest is ' + close + ' miles away',
			icon: 'me.png'
		});
		marker.setMap(map);

		var infowindow = new google.maps.InfoWindow();
				
		// Open info window on click of marker
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(this.title);
			infowindow.open(map, this);
		});
	}

</script>

</head>

<body onload="getLocation()">
	<h1>Welcome to NotUber</h1>
	<div id="map_canvas"></div>
</body>
</html>